---
# 1) nettoyage anciennes règles polkit user-only
- name: Supprimer anciennes règles polkit libvirt (doublons / per-user)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/polkit-1/rules.d/50-libvirt.rules
    - /etc/polkit-1/rules.d/50-libvirt-jd.rules

# 2) déployer règle unique basée sur groupes
- name: Polkit libvirt (group-based)
  ansible.builtin.template:
    src: 49-org.libvirt.rules.j2
    dest: /etc/polkit-1/rules.d/49-org.libvirt.rules
    owner: root
    group: root
    mode: '0644'

# 3) UFW: autoriser cockpit uniquement depuis admin_cidr
- name: UFW autoriser Cockpit seulement depuis admin_cidr
  when: admin_cidr is defined and admin_cidr|length > 0
  community.general.ufw:
    rule: allow
    port: '9090'
    proto: tcp
    src: "{{ admin_cidr }}"
  notify: reload ufw

# 4) Override cockpit.socket bind IP si fournie
- name: Créer dossier d’override cockpit.socket si bind IP
  when: (cockpit_bind_ip | default('')) | length > 0
  ansible.builtin.file:
    path: /etc/systemd/system/cockpit.socket.d
    state: directory
    mode: '0755'

- name: Déployer override de socket (si bind IP)
  when: (cockpit_bind_ip | default('')) | length > 0
  ansible.builtin.template:
    src: cockpit-override.conf.j2
    dest: /etc/systemd/system/cockpit.socket.d/override.conf
    mode: '0644'
  notify:
    - daemon-reload
    - restart cockpit

# 5) Redémarrer libvirt (auto-détection services/sockets, compatible Ubuntu/Debian)
- name: Découvrir les unités systemd disponibles
  ansible.builtin.service_facts:

- name: Construire la liste des unités libvirt à redémarrer (services prioritaires)
  ansible.builtin.set_fact:
    _svc_keys: "{{ ansible_facts.services.keys() | list }}"
    libvirt_units_to_restart: >-
      {{
        (['libvirtd.service', 'virtqemud.service', 'libvirt-daemon.service', 'libvirt-bin.service']
        | select('in', ansible_facts.services.keys() | list) | list)
      }}

- name: Si aucun service trouvé, basculer sur sockets
  ansible.builtin.set_fact:
    libvirt_units_to_restart: >-
      {{
        libvirt_units_to_restart
        if (libvirt_units_to_restart | length) > 0
        else (['libvirtd.socket', 'virtqemud.socket']
              | select('in', ansible_facts.services.keys() | list) | list)
      }}

- name: Redémarrer libvirt (services ou sockets) si détecté
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: restarted
    daemon_reload: yes
  loop: "{{ libvirt_units_to_restart }}"
  when: libvirt_units_to_restart | length > 0

- name: Aucun service/socket libvirt détecté – rien à redémarrer
  ansible.builtin.debug:
    msg: "Aucune unité libvirt* présente (service ni socket). Rien à redémarrer."
  when: libvirt_units_to_restart | length == 0
